/**
 * @summary     TableCalc
 * @description Calculate in HTML tables
 * @version     2.0.7
 * @file        jquery.tablecalc.min.js
 * @author      Tommy Hansen
 * @copyright   Consortia AS, Copyright 2018-2019.
 * @license     When used with Consortia products (license) no other license is needed
 */
!function($,window){"use strict";var calcRow={},settings={},licM="<h2>PS! Your license is not valid or has expired, please renew!</h2>",liv=!1,methods={init:function(l){return l=$.extend({},$.fn.tableCalc.defaults,l),(settings=l).filterRows={},this.each(function(){var e=$(this);settings.data||(settings.data=e.data(e[0].nodeName,e[0].id),setEvent.call(this,l),settings.calcOnLoad&&calculate(settings.calcType,settings.calcCustom,settings))})},destroy:function(){return $(window).off(".tableCalc"),this.each(function(){var e=$(this);e.data("tableCalc");e.removeData("tableCalc")})},getCurrentRow:function(){return calcRow.obj?calcRow.obj:0},calculate:function(e,l){return settings.data=this,calculate(e,l,settings)},getAllRows:function(){return settings.data=this,getAllRows(settings)},getSum:function(e){return liv?(settings.data=this,getSum(settings,e)):0},getAverage:function(e){return liv?(settings.data=this,getAverage(settings,e)):0},getMin:function(e){return liv?(settings.data=this,getMin(settings,e)):0},getMax:function(e){return liv?(settings.data=this,getMax(settings,e)):0},sortColumn:function(e,l){return liv?(settings.data=this,sortColumn(settings,e,l)):0}};function getMin(e,l){var t=getSumArray(e,l);return Number(t.reduce(function(e,l){return Math.min(e,l)}))}function getMax(e,l){var t=getSumArray(e,l);return Number(t.reduce(function(e,l){return Math.max(e,l)}))}function getSum(e,l){for(var t=getSumArray(e,l),n=0,a=0;a<t.length;a++)0<t[a].length&&(n+=parseFloat(t[a]));return n.toFixed(e.decimals)}function getAverage(e,l){for(var t=getSumArray(e,l),n=0,a=0,c=0,r=0;r<t.length;r++)0<t[r].length&&(n+=parseFloat(t[r]),c++);return 0<n&&(a=n/c),a.toFixed(e.decimals)}function getAllRows(e){var l=e.data,t={},n=[];try{t=l[0].children[1].rows}catch(e){console.log("No rows found: "+e.message)}for(var a=0;a<t.length;a++){var c=t[a];if(0<e.textColumns.length)for(var r=0;r<e.textColumns.length;r++){var s=c.cells[e.textColumns[r]].children[0].type;"SELECT"===c.cells[e.textColumns[r]].children[0].nodeName&&(s="select");var i="",o=c.cells[e.textColumns[r]].children.length;switch(s){case"date":case"datetime":case"text":i=c.cells[e.textColumns[r]].children[0].value;break;case"checkbox":i=c.cells[e.textColumns[r]].children[0].checked;break;case"radio":for(a=0;a<o;a++)if("INPUT"===c.cells[e.textColumns[r]].children[a].nodeName&&c.cells[e.textColumns[r]].children[a].checked){i=c.cells[e.textColumns[r]].children[a].id;break}break;case"select":o=c.cells[e.textColumns[r]].children[0].children.length;for(a=0;a<o;a++)if(c.cells[e.textColumns[r]].children[0].children[a].selected){i=c.cells[e.textColumns[r]].children[0].children[a].value;break}break;default:try{i=c.cells[e.textColumns[r]].children[0].value}catch(e){i="Input type not supported "}}n.push(JSON.stringify({id:t[a].children[e.rowId].id,column:t[a].children[e.textColumns[r]].cellIndex,value:i}))}if(0<e.calcColumns.length)for(r=0;r<e.calcColumns.length;r++)n.push(JSON.stringify({id:t[a].children[e.rowId].id,column:t[a].children[e.calcColumns[r]].cellIndex,value:t[a].children[e.calcColumns[r]].children[0].value}));null!==e.calcColumn_sum&&n.push(JSON.stringify({id:t[a].children[e.rowId].id,column:t[a].children[e.calcColumn_sum].cellIndex,value:t[a].children[e.calcColumn_sum].children[0].value}))}return n}function getSumArray(e,l){if(null!==e.calcColumn_sum){var t=e.data,n={},a=[];try{n=t[0].children[1].rows}catch(e){console.log("No rows found: "+e.message)}for(var c=0;c<n.length;c++)null==l?a.push(n[c].children[e.calcColumn_sum].children[0].value.replace(",",".")):a.push(n[c].children[l].children[0].value.replace(",","."));return a}}function calculate(e,l,t){if(0<e.length){"c"==(t.calcType=e).toLowerCase()&&0<l.length&&(t.calcCustom=l);var n="",a=t.calcCustom.split("==");if(1<a.length){t.calcCustom=a[0],n=a[1].split(":")[1].trim();for(var c,r=/0:[0-9]*/g,s=[];c=r.exec(t.calcCustom);)s.push(c[0].split(":")[1]);calcSpecial(t,s,n)}else calcOnLoad(t)}}function setEvent(h){var m=h.data;if(!liv){if(!valLic(h.license))return m[0].innerHTML=licM,0;liv=!0}$("#"+m[0].id+" input").on(h.onEvent,function(e){var l=$(this);if(l.closest("td").index()===h.calcColumn_sum)return 0;var t=$(this).closest("tr")[0].sectionRowIndex,n=m[0].children[1].rows[t];calcRow.obj=[];var a=0;null!==h.rowId&&(a=l.closest("tr").find("td:eq("+h.rowId+")").text());try{if(0<h.textColumns.length)for(var c=0;c<h.textColumns.length;c++){var r=n.cells[h.textColumns[c]].children[0].type;"SELECT"===n.cells[h.textColumns[c]].children[0].nodeName&&(r="select");var s="",i=n.cells[h.textColumns[c]].children.length;switch(r){case"date":case"datetime":case"text":s=n.cells[h.textColumns[c]].children[0].value;break;case"checkbox":s=n.cells[h.textColumns[c]].children[0].checked;break;case"radio":for(var o=0;o<i;o++)if("INPUT"===n.cells[h.textColumns[c]].children[o].nodeName&&n.cells[h.textColumns[c]].children[o].checked){s=n.cells[h.textColumns[c]].children[o].id;break}break;case"select":i=n.cells[h.textColumns[c]].children[0].children.length;for(o=0;o<i;o++)if(n.cells[h.textColumns[c]].children[0].children[o].selected){s=n.cells[h.textColumns[c]].children[0].children[o].value;break}break;default:try{s=n.cells[h.textColumns[c]].children[0].value}catch(e){s="Input type not supported"}}calcRow.obj.push(JSON.stringify({id:a,column:h.textColumns[c],value:s}))}}catch(e){console.log("Get textcolumn value fails: "+e.message)}try{if(0<h.calcColumns.length){var u=[];for(o=0;o<h.calcColumns.length;o++)if(this.parentElement.cellIndex===h.calcColumns[o]){s=parseFloat(this.value.toString().replace(",","."));u.push(JSON.stringify({id:o,value:s})),calcRow.obj.push(JSON.stringify({id:a,column:h.calcColumns[o],value:s}))}else{s=parseFloat(n.cells[h.calcColumns[o]].children[0].value.toString().replace(",","."));u.push(JSON.stringify({id:o,value:s})),calcRow.obj.push(JSON.stringify({id:a,column:h.calcColumns[o],value:s}))}var d=parseFloat(getCalculateResult(h,u)).toFixed(h.decimals);calcRow.obj.push(JSON.stringify({id:a,column:h.calcColumn_sum,value:d})),l.closest("tr").find("td:eq("+h.calcColumn_sum+") input").val(d)}}catch(e){console.log("Get numbercolumn value fails: "+e.message)}})}function calcOnLoad(e){var l=e.data,t={};if(!liv){if(!valLic(e.license))return l[0].innerHTML=licM,0;liv=!0}try{t=l[0].children[1].rows}catch(e){console.log("No rows found: "+e.message)}for(var n=0;n<t.length;n++)for(var a=t[n].cells,c=[],r=0;r<a.length;r++){var s=a[r];if("TD"===s.nodeName){var i=0;if(0<e.calcColumns.length)for(var o=0;o<e.calcColumns.length;o++)if(e.calcColumns[o]===s.cellIndex){var u=s.children[0];try{"INPUT"===u.nodeName&&c.push(JSON.stringify({id:o,value:u.value}))}catch(e){console.log("Info: "+e.message+", happens if row is missing input fields for calculation")}}if(e.calcColumns.length===c.length){i=getCalculateResult(e,c);try{i=parseFloat(i).toFixed(e.decimals)}catch(e){console.log("Result: "+e.message)}}if(s.cellIndex===e.calcColumn_sum&&(s.children[0].value=i,e.calcColumns.length===c.length)){c=[];continue}}}}function calcSpecial(e,l,t){var n=e.data,a={};try{a=n[0].children[1].rows}catch(e){console.log("No rows found: "+e.message)}for(var c=[],r=0;r<a.length;r++){for(var s=a[r].cells,i=0;i<l.length;i++)for(var o=0;o<s.length;o++)s[o].cellIndex===e.calcColumns[l[i]]&&c.push(JSON.stringify({id:l[i],value:s[o].children[0].value}));if(c.length===l.length){var u=getCalculateResult(e,c);u=parseFloat(u).toFixed(e.decimals),s[t].children[0].value=u,c=[]}}}function getCalculateResult(options,params){try{var retVal=0;if(0===params.length)return 0;var i=0;switch(options.calcType.toLowerCase()){case"a":for(i=0;i<params.length;i++){var j=JSON.parse(params[i]);0===i?retVal=Number(j.value):retVal+=Number(j.value)}return retVal;case"s":for(i=0;i<params.length;i++){var j=JSON.parse(params[i]);0===i?retVal=Number(j.value):retVal-=Number(j.value)}return retVal;case"m":for(i=0;i<params.length;i++){var j=JSON.parse(params[i]);0===i?retVal=Number(j.value):retVal*=Number(j.value)}return retVal;case"d":var strCalc="";for(i=0;i<params.length;i++){var j=JSON.parse(params[i]);strCalc+=j.value.toString()+"/ "}return strCalc=strCalc.slice(0,strCalc.length-2),eval(strCalc);case"c":var custom=options.calcCustom,expression=/0:[0-9]*/;for(i=0;i<params.length;i++){var j=JSON.parse(params[i]),str=new RegExp("0:"+j.id,"g");expression.test(custom)&&(0==j.value.length&&(j.value=0),custom=custom.replace(str,j.value))}return retVal=eval(custom),retVal;default:return 0}}catch(e){console.log("Calculation fails:"+e.message),$.error("Calculation fails:"+e.message)}return 0}function valLic(e){return!0}function sortColumn(e,l,t){var n=e.data,a={};try{a=n[0].children[1].rows}catch(e){return console.log("No rows found: "+e.message),0}for(var c,r,s=!0,i=0,o="asc";s;){for(s=!1,r=0;r<a.length-1;r++){c=!1;var u=a[r].cells[l],d=a[r+1].cells[l],h=!1;if(0<u.children.length)"input"==u.children[0].nodeName.toLowerCase()&&(h=!0,"number"===t&&(u=""==u.children[0].value?0:parseFloat(u.children[0].value.replace(/[^0-9.-]/g,"")),d=""==d.children[0].value?0:parseFloat(d.children[0].value.replace(/[^0-9.-]/g,""))),"text"===t&&(u=u.children[0].value.replace(/^\s+|\s+$/g,""),d=d.children[0].value.replace(/^\s+|\s+$/g,"")),"date"===t&&(u=""==u.children[0].value?new Date(-2592e7):new Date(u.children[1].value),d=""==d.children[0].value?new Date(-2592e7):new Date(d.children[1].value)));if(h||("number"===t&&(u=u.innerText.replace(/[^0-9.-]/g,""),d=d.innerText.replace(/[^0-9.-]/g,"")),"text"===t&&(u=u.innerText.replace(/^\s+|\s+$/g,""),d=d.innerText.replace(/^\s+|\s+$/g,"")),"date"===t&&(u=""==u.innerText?new Date(-2592e7):new Date(u.innerText),d=""==d.innerText?new Date(-2592e7):new Date(d.innerText))),u!==d)if("asc"===o){if(d<u){c=!0;break}}else if("desc"===o&&u<d){c=!0;break}}c?(a[r].parentNode.insertBefore(a[r+1],a[r]),s=!0,i++):0==i&&"asc"==o&&(o="desc",s=!0)}}function gsp(e){var n={};return location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,l,t){n[l]=t}),e?n[e]:n}$.fn.tableCalc=function(e){return methods[e]?methods[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void $.error("Method "+e+" does not exist in plugin"):methods.init.apply(this,arguments)},$.fn.tableCalc.defaults={onEvent:"change",calcType:"m",calcColumns:[],calcColumn_sum:null,rowId:null,textColumns:[],calcCustom:"",decimals:2,calcOnLoad:!0,getMin:$.noop,getMax:$.noop,getSum:$.noop,getAverage:$.noop,getCurrentRow:$.noop,getAllRows:$.noop,calculate:$.noop,sortColumn:$.noop,filterRows:$.noop,license:null}}(jQuery,window);